-- Large string and large binary type tests (LARGE_STRING, LARGE_BINARY)
SET datestyle = 'ISO';
SET client_min_messages = WARNING;
SET log_statement TO 'none';

-- Clean up any leftover objects from previous test runs
DROP EXTENSION IF EXISTS parquet_fdw CASCADE;
DROP ROLE IF EXISTS regress_parquet_fdw;

-- Create fresh objects
CREATE EXTENSION parquet_fdw;
CREATE ROLE regress_parquet_fdw LOGIN SUPERUSER;
CREATE SERVER parquet_srv FOREIGN DATA WRAPPER parquet_fdw;
CREATE USER MAPPING FOR regress_parquet_fdw SERVER parquet_srv;
SET ROLE regress_parquet_fdw;

-- Create foreign table mapping large types to TEXT/BYTEA
CREATE FOREIGN TABLE large_types_test (
    id    INT,
    lstr  TEXT,               -- LARGE_STRING -> TEXT
    lbin  BYTEA,              -- LARGE_BINARY -> BYTEA
    str   TEXT                -- STRING -> TEXT (for comparison)
)
SERVER parquet_srv
OPTIONS (filename '@abs_srcdir@/data/simple/example_large_types.parquet');

-- Test 1: Read all data (both row groups)
SELECT id, lstr, lbin, str FROM large_types_test ORDER BY id;

-- Test 2: NULLs are handled correctly
SELECT id, lstr, lbin FROM large_types_test WHERE lstr IS NULL ORDER BY id;
SELECT id, lstr, lbin FROM large_types_test WHERE lbin IS NULL ORDER BY id;

-- Test 3: Filter on LARGE_STRING
SELECT id, lstr FROM large_types_test WHERE lstr = 'beta';

-- Test 4: Filter on LARGE_STRING with LIKE
SELECT id, lstr FROM large_types_test WHERE lstr LIKE '%eta' ORDER BY id;

-- Test 5: Aggregates
SELECT COUNT(*), COUNT(lstr), COUNT(lbin) FROM large_types_test;

-- Clean up
DROP FOREIGN TABLE large_types_test;
DROP USER MAPPING FOR regress_parquet_fdw SERVER parquet_srv;
DROP SERVER parquet_srv CASCADE;
RESET ROLE;
DROP ROLE regress_parquet_fdw;
DROP EXTENSION parquet_fdw CASCADE;
