-- Time64 and Decimal type tests
SET datestyle = 'ISO';
SET client_min_messages = WARNING;
SET log_statement TO 'none';
-- Clean up any leftover objects from previous test runs
DROP EXTENSION IF EXISTS parquet_fdw CASCADE;
DROP ROLE IF EXISTS regress_parquet_fdw;
-- Create fresh objects
CREATE EXTENSION parquet_fdw;
CREATE ROLE regress_parquet_fdw LOGIN SUPERUSER;
CREATE SERVER parquet_srv FOREIGN DATA WRAPPER parquet_fdw;
CREATE USER MAPPING FOR regress_parquet_fdw SERVER parquet_srv;
SET ROLE regress_parquet_fdw;
-- Test 1: Create foreign table with Time64 and Decimal columns
CREATE FOREIGN TABLE time_decimal_test (
    id INT,
    time_us TIME,         -- Time64 microseconds
    time_ns TIME,         -- Time64 nanoseconds (converted to microseconds)
    price NUMERIC(10,2),  -- Decimal128
    amount NUMERIC(18,6), -- Decimal128
    name TEXT
)
SERVER parquet_srv
OPTIONS (filename '@abs_srcdir@/data/simple/example_time_decimal.parquet');
-- Test 2: Read all data
SELECT * FROM time_decimal_test ORDER BY id;
 id |     time_us     |     time_ns     |    price    |       amount        |  name  
----+-----------------+-----------------+-------------+---------------------+--------
  1 | 12:30:45.123456 | 12:30:45.123457 |      123.45 |       123456.789012 | first
  2 | 08:15:30.5      | 08:15:30.5      | 99999999.99 | 999999999999.999999 | second
  3 | 23:59:59.999999 | 24:00:00        |      -50.00 |           -0.000001 | third
  4 | 00:00:00        | 00:00:00        |        0.01 |            0.000000 | fourth
  5 | 18:00:00        | 18:00:00.000001 |        0.00 |            1.500000 | fifth
(5 rows)

-- Test 3: Filter on TIME column
SELECT id, time_us, name FROM time_decimal_test WHERE time_us > '12:00:00' ORDER BY id;
 id |     time_us     | name  
----+-----------------+-------
  1 | 12:30:45.123456 | first
  3 | 23:59:59.999999 | third
  5 | 18:00:00        | fifth
(3 rows)

-- Test 4: Filter on DECIMAL column
SELECT id, price, name FROM time_decimal_test WHERE price > 100 ORDER BY id;
 id |    price    |  name  
----+-------------+--------
  1 |      123.45 | first
  2 | 99999999.99 | second
(2 rows)

-- Test 5: Filter on negative decimal
SELECT id, price, amount FROM time_decimal_test WHERE price < 0 ORDER BY id;
 id | price  |  amount   
----+--------+-----------
  3 | -50.00 | -0.000001
(1 row)

-- Test 6: Arithmetic with decimal columns (using wider precision to avoid overflow)
SELECT id, price, amount, (price + amount)::numeric(20,2) as total FROM time_decimal_test WHERE id <= 3 ORDER BY id;
 id |    price    |       amount        |      total       
----+-------------+---------------------+------------------
  1 |      123.45 |       123456.789012 |        123580.24
  2 | 99999999.99 | 999999999999.999999 | 1000099999999.99
  3 |      -50.00 |           -0.000001 |           -50.00
(3 rows)

-- Test 7: Aggregates on decimal columns
SELECT SUM(price) as total_price, AVG(price) as avg_price, MIN(price) as min_price, MAX(price) as max_price FROM time_decimal_test;
 total_price  |       avg_price       | min_price |  max_price  
--------------+-----------------------+-----------+-------------
 100000073.45 | 20000014.690000000000 |    -50.00 | 99999999.99
(1 row)

-- Test 8: Time comparisons
SELECT id, time_us, time_ns FROM time_decimal_test WHERE time_us = time_ns ORDER BY id;
 id |  time_us   |  time_ns   
----+------------+------------
  2 | 08:15:30.5 | 08:15:30.5
  4 | 00:00:00   | 00:00:00
(2 rows)

-- Test 9: Midnight time
SELECT id, time_us, time_ns FROM time_decimal_test WHERE time_us = '00:00:00' ORDER BY id;
 id | time_us  | time_ns  
----+----------+----------
  4 | 00:00:00 | 00:00:00
(1 row)

-- Clean up
DROP FOREIGN TABLE time_decimal_test;
DROP USER MAPPING FOR regress_parquet_fdw SERVER parquet_srv;
DROP SERVER parquet_srv CASCADE;
RESET ROLE;
DROP ROLE regress_parquet_fdw;
DROP EXTENSION parquet_fdw CASCADE;
