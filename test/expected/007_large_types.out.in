-- Large type tests (LARGE_STRING, LARGE_BINARY, LARGE_LIST)
SET datestyle = 'ISO';
SET client_min_messages = WARNING;
SET log_statement TO 'none';
-- Clean up any leftover objects from previous test runs
DROP EXTENSION IF EXISTS parquet_fdw CASCADE;
DROP ROLE IF EXISTS regress_parquet_fdw;
-- Create fresh objects
CREATE EXTENSION parquet_fdw;
CREATE ROLE regress_parquet_fdw LOGIN SUPERUSER;
CREATE SERVER parquet_srv FOREIGN DATA WRAPPER parquet_fdw;
CREATE USER MAPPING FOR regress_parquet_fdw SERVER parquet_srv;
SET ROLE regress_parquet_fdw;
-- Create foreign table mapping large types to TEXT/BYTEA/ARRAY
CREATE FOREIGN TABLE large_types_test (
    id    INT,
    lstr  TEXT,               -- LARGE_STRING -> TEXT
    lbin  BYTEA,              -- LARGE_BINARY -> BYTEA
    str   TEXT,               -- STRING -> TEXT (for comparison)
    llist BIGINT[]            -- LARGE_LIST -> ARRAY
)
SERVER parquet_srv
OPTIONS (filename '@abs_srcdir@/data/simple/example_large_types.parquet');
-- Test 1: Read all data (both row groups)
SELECT id, lstr, lbin, str FROM large_types_test ORDER BY id;
 id |  lstr   |    lbin    |  str  
----+---------+------------+-------
  1 | alpha   | \x000102   | one
  2 | beta    | \xfeff     | two
  3 | gamma   | \xdeadbeef | three
  4 |         | \xcafe     | four
  5 | epsilon |            | five
  6 | zeta    | \x00       | six
(6 rows)

-- Test 2: NULLs are handled correctly
SELECT id, lstr, lbin FROM large_types_test WHERE lstr IS NULL ORDER BY id;
 id | lstr |  lbin  
----+------+--------
  4 |      | \xcafe
(1 row)

SELECT id, lstr, lbin FROM large_types_test WHERE lbin IS NULL ORDER BY id;
 id |  lstr   | lbin 
----+---------+------
  5 | epsilon | 
(1 row)

-- Test 3: Filter on LARGE_STRING
SELECT id, lstr FROM large_types_test WHERE lstr = 'beta';
 id | lstr 
----+------
  2 | beta
(1 row)

-- Test 4: Filter on LARGE_STRING with LIKE
SELECT id, lstr FROM large_types_test WHERE lstr LIKE '%eta' ORDER BY id;
 id | lstr 
----+------
  2 | beta
  6 | zeta
(2 rows)

-- Test 5: Aggregates
SELECT COUNT(*), COUNT(lstr), COUNT(lbin) FROM large_types_test;
 count | count | count 
-------+-------+-------
     6 |     5 |     5
(1 row)

-- Test 6: Read LARGE_LIST data
SELECT id, llist FROM large_types_test ORDER BY id;
 id |   llist   
----+-----------
  1 | {1,2,3}
  2 | {4,5}
  3 | {6,7,8,9}
  4 | 
  5 | {10,11}
  6 | {12}
(6 rows)

-- Test 7: LARGE_LIST NULLs
SELECT id, llist FROM large_types_test WHERE llist IS NULL ORDER BY id;
 id | llist 
----+-------
  4 | 
(1 row)

-- Test 8: LARGE_LIST with other columns
SELECT id, lstr, llist FROM large_types_test WHERE id <= 3 ORDER BY id;
 id | lstr  |   llist   
----+-------+-----------
  1 | alpha | {1,2,3}
  2 | beta  | {4,5}
  3 | gamma | {6,7,8,9}
(3 rows)

-- Clean up
DROP FOREIGN TABLE large_types_test;
DROP USER MAPPING FOR regress_parquet_fdw SERVER parquet_srv;
DROP SERVER parquet_srv CASCADE;
RESET ROLE;
DROP ROLE regress_parquet_fdw;
DROP EXTENSION parquet_fdw CASCADE;
